# Game Management Plan — Snap and Seek

This doc describes the game management flow: create game → share link → players join → lobby → start game (hiding mode). It covers Supabase setup, pages, routes, and the “magic” join links.

---

## 1. Supabase: What You Need

### 1.1 Tables (you already have these)

**`games`**
```sql
create table public.games (
  id uuid not null default gen_random_uuid(),
  name text null,
  status text null default 'lobby',
  created_at timestamp with time zone null default now(),
  constraint games_pkey primary key (id)
) TABLESPACE pg_default;
```

**`players`**
```sql
create table public.players (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  name text not null default ''::text,
  game_id uuid not null,
  constraint players_pkey primary key (id),
  constraint players_game_id_fkey foreign key (game_id) references games (id) on update cascade on delete cascade
) TABLESPACE pg_default;
```

**Change from your current schema:**  
- Default `status` from `'active'` to `'lobby'` so “waiting for players” is explicit.  
- Constraint name `user_pkey` → `players_pkey` and `user_game_id_fkey` → `players_game_id_fkey` for clarity (optional).

If you prefer to keep `status default 'active'` and treat “active” as lobby, that’s fine; the app will use two status values: **lobby** (or active) and **hiding**.

### 1.2 Status values

| Status   | Meaning                                      |
|----------|----------------------------------------------|
| `lobby`  | Game created; waiting for players; can join. |
| `hiding` | Game started; players are in “hiding” phase. |

Later you can add e.g. `seeking`, `ended`.

### 1.3 Supabase changes to make

1. **Ensure tables exist**  
   Run the `games` and `players` SQL above in the Supabase SQL Editor (create or alter as needed).

2. **Optional: default status**  
   If you already have `default 'active'`, either:
   - Leave it and treat `active` as lobby in the app, **or**
   - `ALTER TABLE public.games ALTER COLUMN status SET DEFAULT 'lobby';`

3. **RLS (optional for hackathon)**  
   Per project brief, RLS is not required; the app uses the **service role** from API routes / Server Components. If you enable RLS later:
   - Allow anonymous or authenticated read/insert on `games` and `players` as needed for join/lobby.
   - Or keep using the service role from the Next.js backend only.

4. **Index (recommended)**  
   Speeds up “players in this game” and “game by id”:
   ```sql
   create index if not exists players_game_id_idx on public.players (game_id);
   ```

No other Supabase config is required for the flows below.

---

## 2. Routes and Pages

| Route | Purpose |
|-------|--------|
| `/` | Landing: hero + single link to “Manage games” (game management). |
| `/games` | **Game management**: list games, button “Create new game”. |
| `/games/new` | **Create game**: form (game name) → POST → create row in `games` → redirect to game page with share link. |
| `/games/[gameId]` | **Game page**: if no game → 404; else show game name, shareable join link, list of players, “Start game” when ready. |

**Join flow (magic link):**

| Route | Purpose |
|-------|--------|
| `/join/[gameId]` | **Join page**: user lands here from share link. Form: “Your name” + “Add me”. POST creates a row in `players` for this `game_id`, then redirects to `/games/[gameId]` (lobby). |

So:
- **Shareable link** = `https://<your-domain>/join/<game-uuid>`.
- No auth required: anyone with the link can add themselves as a player (hackathon shortcut).

---

## 3. Flows

### 3.1 Landing → Game management

1. User opens `/`.
2. Sees hero (“Snap and Seek”) and one clear link: **Manage games** → `/games`.
3. Optional: keep a small footer link to “Location test” or other tools.

### 3.2 Create a new game

1. User is on `/games` (game management).
2. Clicks **Create new game**.
3. Goes to `/games/new`.
4. Enters **game name**, submits.
5. **Backend**: POST to API (e.g. `POST /api/games`) that inserts into `games` with `name` and `status: 'lobby'`, returns `id`.
6. Redirect to `/games/[gameId]`.
7. On the game page: show game name, **join link** (e.g. “Copy link: `https://.../join/<uuid>`”), and “Add player” is explained as “send this link to players”.

### 3.3 Share link (magic link)

- Join URL: **`/join/[gameId]`** where `gameId` is `games.id` (UUID).
- Creator copies this from `/games/[gameId]` and sends it (e.g. SMS, WhatsApp).
- No token or login: the UUID in the path is the “magic”; whoever has the link can join.

### 3.4 Add player (join game)

1. Player opens share link → `/join/<gameId>`.
2. Page loads; optional: fetch game name to show “Join: <game name>”.
3. Player enters **name**, clicks **Add me** (or “Join game”).
4. **Backend**: POST to API (e.g. `POST /api/games/[gameId]/players`) that:
   - Validates `gameId` exists and `games.status === 'lobby'`.
   - Inserts into `players` with `game_id = gameId` and `name`.
5. Redirect to `/games/[gameId]` (lobby).
6. Lobby shows all players for that game (from `players` where `game_id = gameId`).

### 3.5 Lobby view and start game

1. All users (creator and joined players) can open `/games/[gameId]` to see:
   - Game name.
   - Join link (for creator to share again).
   - List of **active players** (from `players` for this game).
2. When ready: someone clicks **Start game**.
3. **Backend**: PATCH (e.g. `PATCH /api/games/[gameId]`) setting `status = 'hiding'`.
4. For now: just set status to `hiding`; no further UI change required in this phase (you can later show “Game started — hiding phase” or navigate to a hiding view).

---

## 4. API Routes (Next.js + Supabase)

Use the existing server-side Supabase client (`lib/supabase.ts`, service role).

| Method | Route | Action |
|--------|--------|--------|
| GET | (optional) `api/games` | List games (if you want it for management list). |
| POST | `api/games` | Body: `{ name: string }`. Insert `games`, return `{ id, name, status }`. |
| GET | (optional) `api/games/[gameId]` | Return game + players (or do this in Server Component). |
| PATCH | `api/games/[gameId]` | Body: `{ status: 'hiding' }`. Update `games.status`. |
| POST | `api/games/[gameId]/players` | Body: `{ name: string }`. Insert `players` with `game_id = gameId`. Return player or `{ ok: true }`. |

All writes go through these APIs so the service-role Supabase client is used in one place.

---

## 5. Data Flow Summary

```
Landing (/) 
  → Manage games (/games) 
  → Create new game (/games/new) 
  → [POST api/games] 
  → Game page (/games/[id]) with join link

Join link: /join/[gameId]
  → Enter name, Add me 
  → [POST api/games/[gameId]/players] 
  → Redirect to /games/[gameId] (lobby)

Lobby (/games/[gameId])
  → List players (from Supabase players where game_id = id)
  → Start game 
  → [PATCH api/games/[gameId] { status: 'hiding' }]
  → (For now: just status updated; future: hiding-phase UI)
```

---

## 6. Implementation Checklist

- [ ] Apply schema changes in Supabase (tables, default `status`, index).
- [ ] Simplify `/` to hero + “Manage games” link (clear landing).
- [ ] Add `/games` page: list games, “Create new game” button.
- [ ] Add `/games/new` page: form → POST `/api/games` → redirect to `/games/[id]`.
- [ ] Add `POST /api/games`: create game, return id.
- [ ] Add `/games/[gameId]` page: show name, join link, players list, “Start game” (only when status is lobby).
- [ ] Add `/join/[gameId]` page: form (name) → POST `/api/games/[gameId]/players` → redirect to `/games/[gameId]`.
- [ ] Add `POST /api/games/[gameId]/players`: insert player.
- [ ] Add `PATCH /api/games/[gameId]`: set status to `hiding`.
- [ ] (Optional) GET APIs or Server Component fetches for game + players.

After this, the “magic link” is simply the join URL; no email or auth — just share the link and players can add themselves and see the lobby.
